diff --git a/src/http/ngx_http_upstream.c b/src/http/ngx_http_upstream.c
index 04d813a..83ada81 100644
--- a/src/http/ngx_http_upstream.c
+++ b/src/http/ngx_http_upstream.c
@@ -5930,6 +5930,10 @@ ngx_http_upstream(ngx_conf_t *cf, ngx_command_t *cmd, void *dummy)
 }
 
 
+extern ngx_int_t ngx_http_upstream_dynamic_resolve_directive(ngx_conf_t *cf,
+ngx_http_upstream_server_t *us, ngx_uint_t *i);
+
+
 static char *
 ngx_http_upstream_server(ngx_conf_t *cf, ngx_command_t *cmd, void *conf)
 {
@@ -5958,6 +5962,13 @@ ngx_http_upstream_server(ngx_conf_t *cf, ngx_command_t *cmd, void *conf)
 
     for (i = 2; i < cf->args->nelts; i++) {
 
+        ngx_int_t res = ngx_http_upstream_dynamic_resolve_directive(cf, us, &i);
+        if (res == NGX_ERROR) {
+            goto invalid;
+        } else if (res == NGX_AGAIN) {
+            continue;
+        }
+
         if (ngx_strncmp(value[i].data, "weight=", 7) == 0) {
 
             if (!(uscf->flags & NGX_HTTP_UPSTREAM_WEIGHT)) {
